id: compliance_kyc
name: KYC Verification
description: Perform comprehensive Know Your Customer verification
category: compliance
permissions:
  - compliance:write
  - user:write

rateLimit:
  requests: 100
  window: 60

inputs:
  user_id:
    type: string
    required: true
    description: Unique user identifier
  
  full_name:
    type: string
    required: true
    description: User's full legal name
  
  date_of_birth:
    type: string
    format: date
    required: true
    description: Date of birth (YYYY-MM-DD)
  
  ssn_last4:
    type: string
    pattern: '^\d{4}$'
    description: Last 4 digits of SSN
  
  address:
    type: object
    required: true
    properties:
      street:
        type: string
      city:
        type: string
      state:
        type: string
      postal_code:
        type: string
      country:
        type: string
  
  documents:
    type: array
    items:
      type: object
      properties:
        type:
          type: string
          enum: [passport, drivers_license, national_id]
        number:
          type: string
        country:
          type: string

outputs:
  verified:
    type: boolean
    description: Whether KYC verification passed
  
  risk_score:
    type: number
    minimum: 0
    maximum: 100
    description: Risk score from 0-100
  
  risk_level:
    type: string
    enum: [low, medium, high, critical]
    description: Risk classification
  
  flags:
    type: array
    items:
      type: string
    description: Any compliance flags raised
  
  verification_id:
    type: string
    description: Unique verification transaction ID
  
  next_steps:
    type: array
    items:
      type: string
    description: Required follow-up actions

template: 'KYC verification for {{full_name}} (DOB: {{date_of_birth}})'

providers:
  primary:
    type: api
    endpoint: http://localhost:3004/compliance/comprehensive-check
    headers:
      Content-Type: 'application/json'
    transform: |
      {
        verified: response.data.overall_passed,
        risk_score: response.data.risk_score,
        risk_level: response.data.risk_score < 30 ? 'low' : response.data.risk_score < 60 ? 'medium' : 'high',
        flags: response.data.checks.filter(c => !c.passed).map(c => c.type),
        verification_id: 'veria_' + Date.now(),
        next_steps: response.data.checks.filter(c => !c.passed).map(c => 'Review ' + c.type)
      }
  
  fallback:
    type: mock
    mockResponse:
      verified: true
      risk_score: 25
      risk_level: low
      flags: []
      verification_id: 'mock_kyc_${timestamp}'
      next_steps: []

cache:
  enabled: true
  ttl: 3600  # Cache for 1 hour

webhooks:
  onSuccess: ${WEBHOOK_URL}/kyc/success
  onFailure: ${WEBHOOK_URL}/kyc/failure
  onHighRisk: ${WEBHOOK_URL}/kyc/high-risk

audit:
  enabled: true
  level: detailed
  pii_redaction: true